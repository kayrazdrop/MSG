<!DOCTYPE html>
<html>
<head>
  <title>Mass Transfer Token</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js"></script>
  <script src="https://unpkg.com/web3modal@1.9.12/dist/index.js"></script>
  <script src="https://unpkg.com/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>
</head>
<body>
  <h2>Mass Transfer Token (0G Labs - Testnet)</h2>

  <button onclick="connectWallet()">🔌 Connect Wallet</button>
  <p id="walletAddress">Wallet: <i>Not connected</i></p>

  <label>Token Contract Address:</label><br>
  <input type="text" id="tokenAddress" size="60"><br><br>

  <label>Recipients (comma-separated):</label><br>
  <textarea id="recipients" rows="5" cols="60"></textarea><br><br>

  <label>Amounts (comma-separated, dalam token):</label><br>
  <textarea id="amounts" rows="5" cols="60"></textarea><br><br>

  <button onclick="massTransfer()">🚀 Mass Transfer</button>

  <p id="status"></p>

  <script>
    let provider;
    let signer;
    let web3Modal;
    let instance;

    const abi = [
      "function massTransfer(address[] calldata _recipients, uint256[] calldata _amounts) public returns (bool)",
      "function decimals() public view returns (uint8)"
    ];

    // Set provider options for Web3Modal (0G Labs Testnet)
    const providerOptions = {
      walletconnect: {
        package: window.WalletConnectProvider.default,
        options: {
          rpc: {
            16601: "https://rpc.0g.ai" // 0G Labs Testnet
          },
          chainId: 16601
        }
      }
    };

    web3Modal = new window.Web3Modal.default({
      cacheProvider: false,
      providerOptions
    });

    async function connectWallet() {
      try {
        instance = await web3Modal.connect();
        provider = new ethers.providers.Web3Provider(instance);
        signer = provider.getSigner();
        const address = await signer.getAddress();
        document.getElementById("walletAddress").innerText = "✅ Wallet: " + address;
      } catch (e) {
        alert("❌ Wallet connection failed: " + e.message);
      }
    }

    async function massTransfer() {
      if (!signer) {
        alert('⚠️ Please connect your wallet first.');
        return;
      }

      const tokenAddress = document.getElementById("tokenAddress").value;
      const contract = new ethers.Contract(tokenAddress, abi, signer);

      const recipients = document.getElementById("recipients").value.split(",").map(s => s.trim());
      const amountsRaw = document.getElementById("amounts").value.split(",").map(s => s.trim());

      try {
        const decimals = await contract.decimals();
        const amounts = amountsRaw.map(a => ethers.utils.parseUnits(a, decimals));

        const tx = await contract.massTransfer(recipients, amounts);
        document.getElementById("status").innerText = "⏳ Transaction sent: " + tx.hash;
        await tx.wait();
        document.getElementById("status").innerText = "✅ Success! Tx Hash: " + tx.hash;
      } catch (e) {
        document.getElementById("status").innerText = "❌ Error: " + e.message;
      }
    }
  </script>
</body>
</html>
